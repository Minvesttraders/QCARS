<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quetta Cars</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <!-- Urdu Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu&display=swap" rel="stylesheet"/>

  <style>
    body { font-family: 'Noto Nastaliq Urdu', sans-serif; }
    .hover-3d { transition: transform .3s, box-shadow .3s; }
    .hover-3d:hover { transform: translateY(-6px) rotateX(2deg); box-shadow: 0 8px 16px rgba(0,0,0,0.2); }
    .modal-bg { background: rgba(0,0,0,0.5); }
    .modal-panel { transition: opacity .3s, transform .3s; }
  </style>

  <!-- Appwrite SDK v8 -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@8.4.0"></script>
</head>
<body class="bg-gray-100 text-gray-800">

  <!-- ============ AUTH MODAL ============ -->
  <div id="authModal" class="fixed inset-0 flex items-center justify-center hidden modal-bg">
    <div class="bg-white rounded-lg w-11/12 sm:w-96 p-6 modal-panel scale-90 opacity-0">
      <h2 id="authTitle" class="text-2xl mb-4 text-center">لاگ ان کریں</h2>
      <form id="authForm" class="space-y-4">
        <input name="email" type="email" placeholder="ای میل" required
               class="w-full px-3 py-2 border rounded"/>
        <input name="password" type="password" placeholder="پاس ورڈ" required
               class="w-full px-3 py-2 border rounded"/>
        <button type="submit" class="w-full py-2 bg-teal-400 text-white rounded">
          لاگ ان
        </button>
      </form>
      <p id="switchAuth" class="mt-4 text-center text-sm text-gray-600 cursor-pointer">
        نیا اکاؤنٹ بنائیں
      </p>
    </div>
  </div>

  <!-- ============ HEADER ============ -->
  <header class="bg-gray-800 text-gray-100 p-4 flex justify-between items-center">
    <div class="flex items-center space-x-4">
      <div class="text-2xl font-bold">Quetta Cars</div>
      <input id="searchInput" type="text"
             placeholder="کارز تلاش کریں"
             class="px-3 py-2 rounded bg-gray-700 text-gray-100 focus:outline-none"/>
    </div>
    <div class="flex items-center space-x-4">
      <button id="langToggle" class="px-3 py-2 bg-teal-400 text-gray-800 rounded">EN</button>
      <button id="postBtn" class="px-4 py-2 bg-teal-400 text-gray-800 rounded">+ کار پوسٹ کریں</button>
      <button id="profileBtn" class="text-2xl"><i class="fas fa-user-circle"></i></button>
    </div>
  </header>

  <!-- ============ MAIN FEED ============ -->
  <main id="feed" class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
    <!-- Cards injected here -->
  </main>

  <!-- ============ POST MODAL ============ -->
  <div id="postModal" class="fixed inset-0 flex items-center justify-center hidden modal-bg">
    <div class="bg-white rounded-lg w-11/12 md:w-2/3 lg:w-1/2 p-6 modal-panel scale-90 opacity-0 relative">
      <button id="closePost" class="absolute top-4 left-4 text-gray-600">
        <i class="fas fa-times"></i>
      </button>
      <h2 class="text-2xl mb-4">+ Post Car</h2>
      <form id="postForm" class="space-y-4 max-h-[80vh] overflow-auto">
        <input name="title" type="text" placeholder="Car Name" required
               class="w-full px-3 py-2 border rounded"/>
        <input name="model" type="text" placeholder="Model" required
               class="w-full px-3 py-2 border rounded"/>
        <input name="condition" type="text" placeholder="Condition" required
               class="w-full px-3 py-2 border rounded"/>
        <input name="price" type="number" placeholder="Price" required
               class="w-full px-3 py-2 border rounded"/>
        <textarea name="description" rows="4" placeholder="Description"
                  class="w-full px-3 py-2 border rounded"></textarea>
        <div>
          <label class="block mb-2">Upload Images (max 20)</label>
          <input id="imageInput" type="file" multiple accept="image/*"
                 class="w-full"/>
          <div id="imagePreview" class="grid grid-cols-3 gap-2 mt-2"></div>
        </div>
        <button type="submit" class="w-full py-2 bg-teal-400 text-white rounded">
          Publish
        </button>
      </form>
    </div>
  </div>

  <!-- ============ CHAT MODAL ============ -->
  <div id="chatModal" class="fixed inset-0 flex items-center justify-center hidden modal-bg">
    <div class="bg-white rounded-lg w-11/12 md:w-2/3 lg:w-1/2 p-4 modal-panel scale-90 opacity-0">
      <button id="closeChat" class="absolute top-4 left-4 text-gray-600">
        <i class="fas fa-times"></i>
      </button>
      <div class="flex justify-between items-center mb-4">
        <h2 id="chatTitle" class="text-xl">Global Chat</h2>
        <button id="switchChat" class="px-2 py-1 bg-gray-200 rounded">Private</button>
      </div>
      <div id="chatMessages" class="h-64 overflow-auto space-y-2 mb-4"></div>
      <div class="flex items-center">
        <input id="chatInput" type="text" placeholder="Type a message"
               class="flex-1 px-3 py-2 border rounded"/>
        <button id="sendMsg" class="ml-2 px-4 py-2 bg-teal-400 text-white rounded">
          <i class="fas fa-paper-plane"></i>
        </button>
        <button id="voiceMsg" class="ml-2 px-3 py-2 bg-gray-200 rounded">
          <i class="fas fa-microphone"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ============ ADMIN PANEL ============ -->
  <div id="adminPanel" class="fixed top-0 right-0 bg-white w-80 h-full shadow-lg p-4 overflow-auto hidden">
    <h2 class="text-2xl mb-4">Admin Dashboard</h2>
    <!-- controls injected here -->
  </div>

<script>
  // ======== Appwrite Init ========
  const client = new Appwrite.Client()
    .setEndpoint('https://YOUR_APPWRITE_ENDPOINT/v1')
    .setProject('YOUR_PROJECT_ID');
  const account  = new Appwrite.Account(client);
  const db       = new Appwrite.Databases(client);
  const storage  = new Appwrite.Storage(client);
  const realtime = new Appwrite.Realtime(client);

  // ======== Collections & Buckets IDs ========
  const DATABASE_ID         = 'YOUR_DB_ID';
  const USERS_COLLECTION_ID = 'users';
  const POSTS_COLLECTION_ID = 'posts';
  const CHAT_COLLECTION_ID  = 'chats';
  const BUCKET_ID           = 'car_images';

  // ======== LANGUAGE TOGGLE ========
  const langStr = {
    en: { search: "Search Cars", post: "+ Post Car", login: "Log In", signup: "Sign Up" },
    ur: { search: "کارز تلاش کریں", post: "+ کار پوسٹ کریں", login: "لاگ ان کریں", signup: "نیا اکاؤنٹ" }
  };
  let lang = localStorage.getItem('lang')||'ur';
  function applyLang(){
    document.getElementById('searchInput').placeholder = langStr[lang].search;
    document.getElementById('postBtn').textContent     = langStr[lang].post;
    document.getElementById('authTitle').textContent   = lang==='ur'?langStr.ur.login:langStr.en.login;
    localStorage.setItem('lang', lang);
    document.documentElement.dir = lang==='ur'?'rtl':'ltr';
    document.getElementById('langToggle').textContent = lang==='ur'?'EN':'UR';
  }
  document.getElementById('langToggle').onclick = ()=>{ lang=lang==='ur'?'en':'ur'; applyLang(); };
  applyLang();

  // ======== AUTH ========
  const authModal  = document.getElementById('authModal');
  const authForm   = document.getElementById('authForm');
  const switchAuth = document.getElementById('switchAuth');
  let isSignup    = false;

  async function openAuth(){ 
    authModal.classList.remove('hidden');
    setTimeout(()=>document.querySelector('.modal-panel')
      .classList.replace('scale-90','scale-100'),10);
  }
  switchAuth.onclick = ()=>{
    isSignup = !isSignup;
    document.getElementById('authTitle').textContent = isSignup?langStr[lang].signup:langStr[lang].login;
    authForm.querySelector('button').textContent  = isSignup?langStr[lang].signup:langStr[lang].login;
  };
  authForm.onsubmit = async e=>{
    e.preventDefault();
    const email = e.target.email.value;
    const pw    = e.target.password.value;
    try {
      let user = isSignup
        ? await account.create('unique()', email, pw)
        : await account.createEmailSession(email, pw);
      // auto-admin on first signup
      if(isSignup){
        const list = await db.listDocuments(DATABASE_ID, USERS_COLLECTION_ID, ['\$createdAt\ndesc']);
        if(list.total === 1) user.role = 'admin';
        await db.createDocument(DATABASE_ID, USERS_COLLECTION_ID, user.$id, {
          email, role: user.role||'user', status:'active', joinedAt:new Date().toISOString()
        });
      }
      authModal.classList.add('hidden');
      initApp();
    } catch(err){ alert(err.message); }
  };

  // ======== APP INIT ========
  async function initApp(){
    const session = await account.get();
    if(!session.$id) return openAuth();
    loadFeed();
    subscribeFeed();
    loadAdminPanel();
  }

  // ======== FEED ========
  const feed = document.getElementById('feed');
  async function loadFeed(filter=''){
    const res = await db.listDocuments(DATABASE_ID, POSTS_COLLECTION_ID, [], 100, 0, filter?`title~=${filter}`:undefined);
    feed.innerHTML = '';
    res.documents.forEach(post=>{
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-lg hover-3d cursor-pointer';
      card.innerHTML = `
        <h3 class="font-bold">${post.title}</h3>
        <p class="text-sm text-gray-600">${post.model}</p>
      `;
      card.onclick = ()=>openDetail(post);
      feed.appendChild(card);
    });
  }
  document.getElementById('searchInput')
    .addEventListener('input', e=> loadFeed(e.target.value));

  // realtime feed
  function subscribeFeed(){
    realtime.subscribe(
      [`databases.${DATABASE_ID}.collections.${POSTS_COLLECTION_ID}.documents`],
      msg=> loadFeed(document.getElementById('searchInput').value)
    );
  }

  // ======== POST MODAL ========
  const postBtn   = document.getElementById('postBtn');
  const postModal = document.getElementById('postModal');
  const closePost = document.getElementById('closePost');
  postBtn.onclick  = ()=>{ postModal.classList.remove('hidden'); setTimeout(()=>document.querySelector('#postModal .modal-panel').classList.replace('scale-90','scale-100'),10); };
  closePost.onclick= ()=> postModal.classList.add('hidden');

  // image preview
  const imgIn  = document.getElementById('imageInput');
  const preview= document.getElementById('imagePreview');
  imgIn.onchange = ()=>{
    preview.innerHTML = '';
    Array.from(imgIn.files).slice(0,20).forEach(file=>{
      const r=new FileReader();
      r.onload=e=>{
        const img=document.createElement('img');
        img.src=e.target.result;
        img.className='w-full h-24 object-cover rounded';
        preview.appendChild(img);
      };
      r.readAsDataURL(file);
    });
  };

  // create post
  document.getElementById('postForm').onsubmit = async e=>{
    e.preventDefault();
    const data = new FormData(e.target);
    // 1) create bare post
    const post = await db.createDocument(DATABASE_ID, POSTS_COLLECTION_ID, Appwrite.ID.unique(), {
      title: data.get('title'),
      model: data.get('model'),
      condition: data.get('condition'),
      price: Number(data.get('price')),
      description: data.get('description'),
      createdAt: new Date().toISOString()
    });
    // 2) upload images
    let urls = [];
    for(let f of Array.from(imgIn.files).slice(0,20)){
      const up = await storage.createFile(BUCKET_ID, Appwrite.ID.unique(), f);
      urls.push(`${client.config.endpoint}/storage/buckets/${up.bucketId}/files/${up.$id}/view`);
    }
    // 3) update post
    await db.updateDocument(DATABASE_ID, POSTS_COLLECTION_ID, post.$id, { imageURLs: urls });
    postModal.classList.add('hidden');
  };

  // ======== START ============
  initApp();

  // ========== ADMIN PANEL (stub) ==========
  function loadAdminPanel(){
    // fetch user role and if admin show panel
    account.get().then(u=>{
      db.getDocument(DATABASE_ID, USERS_COLLECTION_ID, u.$id)
        .then(doc=>{
          if(doc.role==='admin') document.getElementById('adminPanel').classList.remove('hidden');
        });
    });
  }

  // detail view, chat, profile & admin actions left as TODO
</script>
</body>
</html>
